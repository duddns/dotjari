<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:widget="http://wzdapi.com/widget/" lang="ko">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="apiVersion" content="1.0" />
    <meta name="author" content="돗자리" />
    <meta name="website" content="http://wzdwoc.springnote.com/pages/719862" />
    <meta name="description" content="씨올 채용검색" />
    <meta name="version" content="1.0" />
    <meta name="autoRefresh" content="1" />
    <title>씨올 채용검색</title>
    <link rel="icon" type="image/gif" href="icon.gif" />
    
    <widget:preferences>
        <widget:preference name="savePref" type="boolean" label="검색조건 저장"/>
        <widget:preference name="listCount" type="range" label="리스트 개수" defaultValue="3" step="1" min="3" max="10" />
        <widget:preference name="company" type="text" label="검색회사명"/>
        <widget:preference name="region" type="text" label="지역"/>
    </widget:preferences>
    
    <style type="text/css">
        /*<![CDATA[*/
        dl {
            padding: 4px;
            border-bottom: 1px solid #e8e8e8;
            clear: both;
            float: left;
            width: 100%;
            color: #777;
        }
        
        dl.even {
            background-color: #f6f6f6;
        }
        /*]]>*/ 
    </style> 
    <script type="text/javascript" src="http://wzdapi.com/widget/emulator.js"></script>
    <script type="text/javascript"> 
    //<![CDATA[
    var Dotjari = {
    
        savePref: false,
        
        listCount: 3,
        
        query: '',
        region: '',
        
        pager: null,
        
        maxPage: 0,
        currentPage: 1,
        
        
        init: function() {
            
            this._initPref();
            
            this._initVar();
            
            this._initEl();
            
            if (this.savePref) {
                this.load();
            } 
        },
        
        
        /*
         * 위젯 설정 내용을 가져와서 변수에 저장합니다.
         */
        _initPref: function() {
        
            this.savePref = widget.getValue('savePref');
        
            this.listCount = widget.getValue('listCount');
            
            this.query = widget.getValue('company');
            this.region = widget.getValue('region');
        },
        
        /*
         * 기본 변수를 초기화 합니다.
         */
        _initVar: function() {
        
            this.pager = null;
        
            this.maxPage = 0;
            this.currentPage = 1;
        },
        
        /*
         * 위젯 HTML을 초기화 합니다.
         *  - 검색조건 화면 설정  
         *  - HTML 이벤트 등록
         */
        _initEl: function() {
        
            if (this.savePref) {
                widget.body.getElementsByClassName('searchWrap')[0].style.display = 'none';
            } else {
                var savePrefEl = widget.body.getElementsByClassName('savePref')[0];
                savePrefEl.onclick = function() {
                    this.savePref = savePrefEl.checked;
                    widget.setValue('savePref', this.savePref);
                    if (this.savePref) {
                        this._getSearchCondition();
                        this._savePref();
                    }
                }.bind(this);
            }

            var searchBtnEl = widget.body.getElementsByClassName('searchBtn')[0];
            searchBtnEl.onclick = function() {
                this._initVar();
                this._getSearchCondition();
                if (this.savePref) {
                    this._savePref();
                }
                this.load();
            }.bind(this);
        },
        
        /*
         * 사용자가 선택한 검색조건을 변수에 저장합니다. 
         */
        _getSearchCondition: function() {
        
            this.query = widget.body.getElementsByClassName('query')[0].value;
            this.region = widget.body.getElementsByClassName('region')[0].value;
        },
        
        /*
         * 검색조건을 위젯 설정창에 저장합니다.
         */
        _savePref: function() {
            
            widget.setValue('company', this.query);
            widget.setValue('region', this.region);
        },
        
        
        /*
         * 저장된 검색조건으로 검색 요청을 보냅니다.
         */
        load: function() {
        
            if ('' == this.query) {
                return;
            }
            
            var url = 'test.xml.php?q=' + this.query; 
            url += '&count=' + this.listCount + '&start=' + (this.currentPage - 1) + '&rgn1=' + this.region;
            UWA.Data.getXml(url, function(res) {
                this._render(res);
            }.bind(this));
        },
        
        /*
         * 검색 결과를 화면에 표시합니다.
         */
        _render: function(res) {
            
            // 리스트 만듦
            this._renderList(res);
            
            // pager 만듦
            var totalCount = this._getNodeValue(res, 'TotalCount');
            this.maxPage = Math.ceil(totalCount / this.listCount);
            this._renderPager();
        },
        
        /*
         * 총 검색 건수와 한 화면에 표시할 갯수를 이용해서 pagenation을 구성합니다.
         */
        _renderPager: function() {
        
            if (pager) {
                return;
            }
        
            var pagerEl = widget.body.getElementsByClassName('pager')[0];
            pagerEl.innerHTML = '';
            
            var pager = new UWA.Controls.Pager();
            pager.setMaxPageNumber(this.maxPage);
            pager.selectPage(this.currentPage);
            pager.onChange = function(pageNo) {
                this.currentPage = pageNo;
                this.load();
            }.bindAsEventListener(this);
            pager.appendTo(pagerEl);
            
            this.pager = pager;
        },
        
        /*
         * 검색 내용을 화면에 표시합니다.
         */
        _renderList: function(res) {
        
            // 결과창 초기화
            var searchResultEl = widget.body.getElementsByClassName('searchResult')[0];
            searchResultEl.innerHTML = '';
            
            var items = res.getElementsByTagName('item');
            var length = items.length;
            for (var i = 0; i < length; i++) {
            
                var listEl = widget.createElement('dl');
                var titleEl = widget.createElement('dt');
                var companyEl = widget.createElement('dd');
                var regionEl = widget.createElement('dd');
                var employTypeEl = widget.createElement('dd');
                var closeDateEl = widget.createElement('dd');
                
                if (0 == i % 2) {
                    listEl.className = 'even';
                }
                
                var title = this._getNodeValue(items[i], 'Job_Title');
                var url = this._getNodeValue(items[i], 'Link_Url');
                var company = this._getNodeValue(items[i], 'Comp_Nm');
                var region = this._getNodeValue(items[i], 'Region_Nm');
                var employType = this._getNodeValue(items[i], 'Employ_Ty_Nm');
                var closeDate = this._getNodeValue(items[i], 'Cl_Invite_Close_Dt');
                
                titleEl.innerHTML = '<a href="' + url + '" target="_blank">' + title + '</a>';
                companyEl.innerHTML = company;
                regionEl.innerHTML = region;
                employTypeEl.innerHTML = employType;
                closeDateEl.innerHTML = closeDate;
               
                listEl.appendChild(titleEl);
                listEl.appendChild(companyEl);
                listEl.appendChild(regionEl);
                listEl.appendChild(employTypeEl);
                listEl.appendChild(closeDateEl);
                
                searchResultEl.appendChild(listEl);
            }
        },
        
        
        _getNodeValue: function(node, tag) {
        
            return node.getElementsByTagName(tag)[0].firstChild.data;
        }
    };

    widget.onLoad = function() {
        Dotjari.init();
    };
    //]]>
    </script>
</head>

<body>
    <div class="searchWrap">
        <div class="search">
            <p>
                <input type="text" class="query" /><button type="submit" class="searchBtn">검색</button>
            </p>
        </div>
        <div class="searchCondition">
            <p>
                <input type="checkbox" class="savePref" /><label>검색조건 저장</label>
            </p>
            <p>
                <label>지역</label>
                <select class="region">
                    <option value="">전체</option>
                    <option value="11">서울</option>
                    <option value="12">부산</option>
                    <option value="13">대구</option>
                    <option value="14">인천</option>
                    <option value="15">광주</option>
                    <option value="16">대전</option>
                    <option value="17">울산</option>
                    <option value="18">경기</option>
                    <option value="19">강원</option>
                    <option value="20">충북</option>
                    <option value="21">충남</option>
                    <option value="22">전북</option>
                    <option value="23">전남</option>
                    <option value="24">경북</option>
                    <option value="25">경남</option>
                    <option value="26">제주</option>
                    <option value="40">특구</option>
                    <option value="59">전국</option>
                    <option value="98">해외</option>
                    <option value="99">기타</option>
                </select>
            </p>
        </div>
    </div>
    <div class="resultWrap"> 
        <div class="searchResult"></div>
        <div class="pager"></div>
    </div>
    <div style="clear:both;" />
</body> 
</html> 
